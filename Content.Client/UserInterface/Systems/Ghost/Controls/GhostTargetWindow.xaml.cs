using System.Linq;
using Content.Client._White.UserInterface.Controls;
using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Content.Shared.Ghost;
using Content.Shared.Mind;
using Content.Shared.Roles;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client.UserInterface.Systems.Ghost.Controls
{
    [GenerateTypedNameReferences]
    public sealed partial class GhostTargetWindow : DefaultWindow
    {
        // WWDP EDIT START
        public static readonly Color AntagonistButtonColor = Color.FromHex("#7F4141");
        public static readonly Color LocationButtonColor = StyleNano.ButtonColorDefault;
        // WWDP EDIT END

        private string _searchText = string.Empty;

        // WWDP EDIT START
        [Dependency] private readonly IPrototypeManager _prototypeManager = default!;

        private ISawmill _logger;

        private List<GhostWarpPlayer> _originalPlayerWarps = new();
        private List<GhostWarpPlace> _originalPlaceWarps = new();
        private List<GhostWarpGlobalRoles> _originalRolesWarps = new();

        private List<GhostWarpPlayer> _playerWarps = new();
        private List<GhostWarpPlace> _placeWarps = new();
        private List<GhostWarpGlobalRoles> _globalRoles = new();

        private List<GhostWarpGlobalRoles> _aliveGlobalRolesList = new();
        private List<GhostWarpGlobalRoles> _deadGlobalRolesList = new();

        private List<GhostWarpPlayer> _alivePlayers = new();
        private List<GhostWarpPlayer> _leftPlayers = new();
        private List<GhostWarpPlayer> _deadPlayers = new();
        private List<GhostWarpPlayer> _ghostPlayers = new();
        // WWDP EDIT END

        public event Action<NetEntity>? WarpClicked;
        public event Action? OnGhostnadoClicked;

        public GhostTargetWindow()
        {
            IoCManager.InjectDependencies(this); // WWDP EDIT
            RobustXamlLoader.Load(this);
            _logger = Logger.GetSawmill("ghostTargetWindow");
            SearchBar.OnTextChanged += OnSearchTextChanged;

            GhostnadoButton.OnPressed += _ => OnGhostnadoClicked?.Invoke();
        }

        public void Populate()
        {
            // WWDP EDIT START
            GhostTeleportContainer.DisposeAllChildren();

            _playerWarps = _originalPlayerWarps.ToList();
            _placeWarps = _originalPlaceWarps.ToList();
            _globalRoles = _originalRolesWarps.ToList();

            PlayersAllocation();
            AddButtons();
            // WWDP EDIT END
        }

        public void UpdateWarps(List<GhostWarpPlayer> players, List<GhostWarpPlace> places, List<GhostWarpGlobalRoles> roles) // WD EDIT
        {
            // WWDP EDIT START
            _originalPlayerWarps = players.ToList();
            _originalPlaceWarps = places.ToList();
            _originalRolesWarps = roles.ToList();

            _playerWarps = _originalPlayerWarps;
            _placeWarps = _originalPlaceWarps;
            _globalRoles = _originalRolesWarps;

            Populate();
            // WWDP EDIT END
        }

        private void AddButtons()
        {
            // WWDP EDIT START
            AddRolesButtons(_aliveGlobalRolesList, "ghost-teleport-menu-antagonists-label");
            AddPlayerButtons(_alivePlayers, "ghost-teleport-menu-alive-label", Color.Black, true); // Alive
            AddPlayerButtons(_ghostPlayers, "ghost-teleport-menu-ghosts-label", Color.Black, true); // Ghost
            AddPlayerButtons(_leftPlayers, "ghost-teleport-menu-left-label", Color.Black, true); // Left
            AddPlayerButtons(_deadPlayers, "ghost-teleport-menu-dead-label", Color.Black, true); // Dead
            AddRolesButtons(_deadGlobalRolesList, "ghost-teleport-menu-dead-antagonists-label");
            AddPlaceButtons(_placeWarps, "ghost-teleport-menu-locations-label", LocationButtonColor);
            // WWDP EDIT END
        }

        // WWDP EDIT START
        private void AddPlayerButtons(List<GhostWarpPlayer> players,
            string text,
            Color buttonColor,
            bool enableByDepartmentColorSheet)
        {
            if (players.Count == 0)
                return;

            var mainContainer = new BoxContainer()
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                HorizontalExpand = true,
                SeparationOverride = 5
            };

            var header = CreateSectionHeader(text);
            mainContainer.AddChild(header);

            var sortedPlayers = SortPlayersByDepartment(players);

            foreach (var departmentList in sortedPlayers)
            {
                if (departmentList.Count == 0 ||
                    !_prototypeManager.TryIndex<DepartmentPrototype>(departmentList[0].DepartmentID, out var departmentPrototype))
                    continue;

                var departmentBox = new FlexBox()
                {
                    AlignContent = FlexBox.FlexAlignContent.SpaceBetween
                };

                if (enableByDepartmentColorSheet)
                    buttonColor = departmentPrototype.Color;

                var labelText = departmentPrototype.Name;

                var departmentLabel = new Label
                {
                    Text = Loc.GetString(labelText) + ": " + departmentList.Count,
                    StyleClasses = { "LabelSecondaryColor" }
                };

                foreach (var player in departmentList)
                {
                    var playerButton = new Button
                    {
                        Text = player.Name,
                        TextAlign = Label.AlignMode.Right,
                        HorizontalAlignment = HAlignment.Center,
                        VerticalAlignment = VAlignment.Center,
                        SizeFlagsStretchRatio = 1,
                        ModulateSelfOverride = buttonColor,
                        ToolTip = player.JobName,
                        TooltipDelay = 0.1f,
                        SetWidth = 180,
                        ClipText = true,
                    };

                    playerButton.Label.ModulateSelfOverride = GetTextColor(buttonColor);

                    playerButton.OnPressed += _ => WarpClicked?.Invoke(player.Entity);

                    departmentBox.AddChild(playerButton);
                }

                mainContainer.AddChild(departmentLabel);
                mainContainer.AddChild(departmentBox);
            }

            GhostTeleportContainer.AddChild(mainContainer);
        }

        private void AddPlaceButtons(List<GhostWarpPlace> places, string text, Color buttonColor)
        {
            if (places.Count == 0)
                return;

            var mainContainer = new BoxContainer()
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                HorizontalExpand = true,
                SeparationOverride = 5
            };

            var header = CreateSectionHeader(text);
            mainContainer.AddChild(header);

            var placesBox = new FlexBox()
            {
                AlignContent = FlexBox.FlexAlignContent.SpaceBetween
            };

            var countLabel = new Label
            {
                Text = Loc.GetString("ghost-teleport-menu-count-label") + ": " + places.Count,
                StyleClasses = { "LabelSecondaryColor" }
            };

            foreach (var place in places)
            {
                var placeButton = new Button
                {
                    Text = place.Name,
                    TextAlign = Label.AlignMode.Right,
                    HorizontalAlignment = HAlignment.Center,
                    VerticalAlignment = VAlignment.Center,
                    SizeFlagsStretchRatio = 1,
                    ModulateSelfOverride = buttonColor,
                    ToolTip = place.Description,
                    TooltipDelay = 0.1f,
                    SetWidth = 180,
                    ClipText = true,
                };

                placeButton.Label.ModulateSelfOverride = GetTextColor(buttonColor);

                placeButton.OnPressed += _ => WarpClicked?.Invoke(place.Entity);

                placesBox.AddChild(placeButton);
            }

            mainContainer.AddChild(countLabel);
            mainContainer.AddChild(placesBox);

            GhostTeleportContainer.AddChild(mainContainer);
        }
        // WWDP EDIT END

        private void OnSearchTextChanged(LineEdit.LineEditEventArgs args)
        {
            // WWDP EDIT START
            _searchText = args.Text.ToLower();

            GhostTeleportContainer.DisposeAllChildren();

            if (string.IsNullOrEmpty(_searchText))
            {
                _playerWarps = _originalPlayerWarps;
                _placeWarps = _originalPlaceWarps;
                _globalRoles = _originalRolesWarps;
            }
            else
            {
                _playerWarps = GetSortedPlayers(_originalPlayerWarps).Where(p => p.Name.ToLower().Contains(_searchText)).ToList();
                _placeWarps = GetSortedPlaces(_originalPlaceWarps).Where(p => p.Name.ToLower().Contains(_searchText)).ToList();
                _globalRoles = GetSortedAntagonists(_originalRolesWarps).Where(a => a.Name.ToLower().Contains(_searchText)).ToList();
            }
            PlayersAllocation();

            AddButtons();
            // WWDP EDIT END
        }

        // WWDP EDIT START
        private void AddRolesButtons(List<GhostWarpGlobalRoles> roles, string text)
        {
            if (roles.Count == 0)
                return;

            var mainContainer = new BoxContainer()
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                HorizontalExpand = true,
                SeparationOverride = 5
            };

            var header = CreateSectionHeader(text);
            mainContainer.AddChild(header);

            var sortedAntags = SortRolesByProto(roles);

            foreach (var (key, rolesList) in sortedAntags)
            {
                if (rolesList.Count == 0 || !_prototypeManager.TryIndex(key, out var roleTypePrototype))
                    continue;

                var departmentBox = new FlexBox()
                {
                    AlignContent = FlexBox.FlexAlignContent.SpaceBetween
                };

                foreach (var role in rolesList)
                {
                    var playerButton = new Button
                    {
                        Text = role.Name,
                        TextAlign = Label.AlignMode.Right,
                        HorizontalAlignment = HAlignment.Center,
                        VerticalAlignment = VAlignment.Center,
                        SizeFlagsStretchRatio = 1,
                        ModulateSelfOverride = roleTypePrototype.Color,
                        ToolTip = Loc.GetString(role.RoleDescription),
                        TooltipDelay = 0.1f,
                        SetWidth = 180,
                        ClipText = true,
                    };

                    playerButton.Label.ModulateSelfOverride = GetTextColor(roleTypePrototype.Color);

                    playerButton.OnPressed += _ => WarpClicked?.Invoke(role.Entity);

                    departmentBox.AddChild(playerButton);
                }

                var departmentLabel = new Label
                {
                    Text = Loc.GetString(roleTypePrototype.Name) + $": {rolesList.Count}",
                    StyleClasses = { "LabelSecondaryColor" }
                };

                mainContainer.AddChild(departmentLabel);
                mainContainer.AddChild(departmentBox);
            }

            GhostTeleportContainer.AddChild(mainContainer);
        }

        private Control CreateSectionHeader(string text, bool useStripeBack = true)
        {
            var label = new Label
            {
                Text = Loc.GetString(text),
                StyleClasses = { "LabelBig" },
                Align = Label.AlignMode.Center,
            };

            if (!useStripeBack)
                return label;

            var stripe = new StripeBack()
            {
                HorizontalExpand = true
            };
            stripe.AddChild(label);

            return stripe;
        }

        public List<List<GhostWarpPlayer>> SortPlayersByDepartment(List<GhostWarpPlayer> players)
        {
            if (players.Count == 0)
                return new List<List<GhostWarpPlayer>>();

            return players
                .GroupBy(GetPlayerWeights)
                .OrderByDescending(g => g.Key)
                .Select(g => g.ToList())
                .ToList();
        }

        private int GetPlayerWeights(GhostWarpPlayer player)
        {
            if (!_prototypeManager.TryIndex<DepartmentPrototype>(player.DepartmentID, out var departmentPrototype))
            {
                _logger.Error($"Error while getting player weights {player.Name} for department {player.DepartmentID}");
                return 0;
            }

            return departmentPrototype.Weight;
        }


        public Dictionary<ProtoId<RoleTypePrototype>, List<GhostWarpGlobalRoles>> SortRolesByProto(List<GhostWarpGlobalRoles> antagonists)
        {
            if (antagonists.Count == 0)
                return [];

            return antagonists.GroupBy(k => new ProtoId<RoleTypePrototype>(k.PrototypeID))
                .ToDictionary(g => g.Key, g => g.ToList());
        }

        private List<GhostWarpPlace> GetSortedPlaces(List<GhostWarpPlace> places)
        {
            return places
                .OrderBy(w => w.Name)
                .ToList();
        }

        private List<GhostWarpPlayer> GetSortedPlayers(List<GhostWarpPlayer> players)
        {
            return players
                .OrderBy(w => w.Name)
                .ToList();
        }

        private List<GhostWarpGlobalRoles> GetSortedAntagonists(List<GhostWarpGlobalRoles> antagonists)
        {
            return antagonists
                .OrderBy(w => w.Name)
                .ToList();
        }

        private void PlayersAllocation()
        {
            _aliveGlobalRolesList = _globalRoles.Where(warp => !warp.IsDead).ToList();
            _deadGlobalRolesList = _globalRoles.Where(warp => warp.IsDead).ToList();

            _alivePlayers = _playerWarps.Where(warp => warp.Status.HasFlag(PlayerStatus.IsAlive)).ToList();
            _deadPlayers = _playerWarps.Where(warp => warp.Status.HasFlag(PlayerStatus.IsDead)).ToList();
            _leftPlayers = _playerWarps.Where(warp => warp.Status.HasFlag(PlayerStatus.IsLeft)).ToList();
            _ghostPlayers = _playerWarps.Where(warp => warp.Status.HasFlag(PlayerStatus.IsGhost)).ToList();
        }

        public static Color GetTextColor(Color background)
        {
            // Perceived luminance formula
            double luminance = (0.299 * background.R +
                0.587 * background.G +
                0.114 * background.B);

            // Light background -> dark text, dark background -> light text
            return luminance > 0.5 ? Color.Black : Color.White;
        }
        //WWDP EDIT END
    }
}
