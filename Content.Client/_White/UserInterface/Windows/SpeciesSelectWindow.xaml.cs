using System.Linq;
using Content.Client._White.UserInterface.Controls;
using Content.Client.Guidebook;
using Content.Client.Humanoid;
using Content.Shared._White.SpeciesDictionary;
using Content.Shared.Humanoid;
using Content.Shared.Humanoid.Prototypes;
using Content.Shared.Preferences;
using Robust.Client.AutoGenerated;
using Robust.Client.Player;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Map;
using Robust.Shared.Prototypes;


namespace Content.Client._White.UserInterface.Windows;


[GenerateTypedNameReferences]
public sealed partial class SpeciesSelectWindow : DefaultWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly DocumentParsingManager _documentParsingManager = default!;
    [Dependency] private readonly IPlayerManager _playerManager = default!;

    public event Action<ProtoId<SpeciesPrototype>>? OnSpeciesSelected;

    private EntityUid _dummyUid;

    private HumanoidCharacterProfile? _dummyProfile;
    private Dictionary<ProtoId<SpeciesPrototype>, SpeciesDictionaryPrototype> _dictionaryCache = [];

    private ProtoId<SpeciesPrototype>? _selectedSpecies;

    public ProtoId<SpeciesPrototype>? SelectedSpecies
    {
        get => _selectedSpecies;
        set
        {
            if(!_prototypeManager.TryIndex<SpeciesPrototype>(value, out var prototype) || _playerManager.LocalSession is null)
                return;

            InfoContainer.Children.Clear();
            _selectedSpecies = value;

            _entityManager.DeleteEntity(_dummyUid);
            SpeciesVisualContainer.Visible = value != null;

            if (_selectedSpecies == null)
                return;

            SpeciesNameLabel.Text = Loc.GetString($"species-name-{_selectedSpecies.Value.Id.ToLower()}");

            if (_dummyProfile != null)
            {
                _dummyProfile = _dummyProfile.WithSpecies(_selectedSpecies.Value);

                _dummyProfile.EnsureValid(_playerManager.LocalSession, IoCManager.Instance!);
            }

            _dummyUid = _entityManager.SpawnEntity(prototype.DollPrototype, MapCoordinates.Nullspace);

            if (_entityManager.TryGetComponent<HumanoidAppearanceComponent>(_dummyUid, out var humanoid))
            {
                var hiddenLayers = humanoid.HiddenLayers;
                var appearanceSystem = _entityManager.System<HumanoidAppearanceSystem>();
                appearanceSystem.LoadProfile(_dummyUid, _dummyProfile, humanoid, false, false);
                // Reapply the hidden layers set from clothing
                appearanceSystem.SetLayersVisibility(_dummyUid, hiddenLayers, false, humanoid: humanoid);
            }

            EntityFrontView.SetEntity(_dummyUid);
            EntityRightView.SetEntity(_dummyUid);

            if(!_dictionaryCache.TryGetValue(_selectedSpecies.Value, out var dictionary))
                return;

            _documentParsingManager.TryAddMarkup(InfoContainer, dictionary.GuidePrototype);
        }
    }


    private List<SpeciesGroupContainer> _groupContainers = new();

    public SpeciesSelectWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        SelectButton.OnPressed += SelectButtonOnOnPressed;
    }

    public void Initialize(HumanoidCharacterProfile characterProfile)
    {
        DisposeContainers();
        _dummyProfile = characterProfile.Clone();

        var groups =
            _prototypeManager.EnumeratePrototypes<SpeciesDictionaryGroupPrototype>().ToList();
        groups.Sort((a, b) => a.Weight.CompareTo(b.Weight));

        foreach (var group in groups)
        {
            var groupContainer = new SpeciesGroupContainer();
            groupContainer.Initialize(group);
            groupContainer.OnSpeciesSelected += OnSpeciesSelectedForView;
            _groupContainers.Add(groupContainer);
            RaceGroupContainer.AddChild(groupContainer);
        }

        foreach (var dictionary in _prototypeManager.EnumeratePrototypes<SpeciesDictionaryPrototype>())
            _dictionaryCache[dictionary.ID] = dictionary;

        SelectedSpecies = characterProfile.Species;
    }

    private void OnSpeciesSelectedForView(ProtoId<SpeciesPrototype> species)
    {
        SelectedSpecies = species;
    }

    private void SelectButtonOnOnPressed(BaseButton.ButtonEventArgs obj)
    {
        if(_selectedSpecies == null)
            return;
        OnSpeciesSelected?.Invoke(_selectedSpecies.Value);
    }

    private void DisposeContainers()
    {
        foreach (var container in _groupContainers)
        {
            container.OnSpeciesSelected -= OnSpeciesSelectedForView;
            container.Clear();
        }
        RaceGroupContainer.Children.Clear();
        _dictionaryCache.Clear();
    }

    public override void Close()
    {
        base.Close();
        _entityManager.DeleteEntity(_dummyUid);
        SelectButton.OnPressed -= SelectButtonOnOnPressed;
        DisposeContainers();
    }
}

